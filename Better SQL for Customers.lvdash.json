{"datasets":[{"name":"e4caf283","displayName":"sql_notebooks","query":"select :workspace_url||'#notebook/'||A.notebookId as notebookURL, \nround(A.sql_percentage*100.,1) sql_percentage, \nB.path as notebookPath,\nA.* except(sql_percentage)\nfrom\n(\n  SELECT workspace_id,\n        request_params.notebookId,\n        request_params.clusterId,\n        count(1) as total_command_execution,\n        count_if(request_params.commandLanguage = 'sql') as sql_command_execution,\n        count_if(request_params.commandLanguage <> 'sql') as non_sql_command_execution,\n        sql_command_execution/total_command_execution as sql_percentage\n  FROM system.access.audit\n  WHERE \n  service_name = 'notebook'\n  and action_name = 'runCommand'\n  and event_date > '2024-07-10'\n  group by workspace_id, request_params.notebookId, request_params.clusterId) A\njoin\n(\n  SELECT distinct workspace_id,\n        request_params.notebookId,\n        request_params.clusterId,\n        request_params.path\n  FROM system.access.audit\n  WHERE \n  service_name = 'notebook'\n  and action_name = 'attachNotebook'\n  and event_date > '2024-07-10') B\non A.clusterId=B.clusterId and A.workspace_id=B.workspace_id and A.notebookId=B.notebookId\nwhere contains(A.clusterId, '-')\norder by sql_percentage desc\nlimit 100","parameters":[{"displayName":"workspace_url","keyword":"workspace_url","dataType":"STRING","defaultSelection":{"values":{"dataType":"STRING","values":[{"value":"https://adb-984752964297111.11.azuredatabricks.net/?o=984752964297111"}]}}}]},{"name":"30567c7e","displayName":"sql_clusters","query":"SELECT a.workspace_id,\n      request_params.clusterId,\n      c.cluster_name,\n      c.cluster_source,\n      count(1) as commands,\n      count_if(request_params.commandLanguage = 'sql') as sql_commands,\n      -- count_if(request_params.commandLanguage <> 'sql') as non_sql_commands,\n      round(sql_commands/commands*100.,1) as sql_percentage\nFROM system.access.audit a\n-- LEFT OUTER JOIN  system.compute.clusters c \nJOIN  system.compute.clusters c \n  ON c.delete_time is NULL \n  AND a.request_params.clusterId = c.cluster_id \n  AND a.workspace_id = c.workspace_id\nWHERE \na.service_name = 'notebook'\nand a.action_name = 'runCommand'\nand a.event_date > date_sub(now(), 30)\nGROUP BY a.workspace_id, request_params.clusterId, c.cluster_name, c.cluster_source\nHAVING contains(request_params.clusterId, '-') and sql_percentage >= 95.0\nORDER BY sql_percentage DESC, commands DESC\nLIMIT 100"},{"name":"20d751a8","displayName":"bi_tools","query":"SELECT\n       sum(u.usage_quantity) AS usage_quantity,\n       count(1) AS count,\n       trim(split(a.user_agent, '/')[0]) AS user_agent,\n       a.request_params.clusterId\n       --collect_list(distinct left(source_ip_address,10)) AS source_ip_addresses\nFROM system.access.audit a\nLEFT OUTER JOIN system.billing.usage u \n  ON a.request_params.clusterId = u.usage_metadata.cluster_id\nWHERE a.user_agent NOT LIKE 'databricks-%'\nAND split(user_agent, '/')[0] NOT IN ('armeria', 'Mozilla', 'Apache-HttpClient', 'mlflow-python-client', 'dbdemos', 'python-urllib3', 'unknown','grpc-python','brickster', 'curl', 'python-requests', 'cli')\nAND event_date > '2024-06-01'\nAND request_params.clusterId is not null\nAND action_name = 'createResult'\n\nGROUP BY ALL\nHAVING usage_quantity > 0\nORDER BY 2 DESC"}],"pages":[{"name":"ab6f6bd7","displayName":"New Page","layout":[{"widget":{"name":"81978477","queries":[{"name":"main_query","query":{"datasetName":"e4caf283","fields":[{"name":"sql_percentage","expression":"`sql_percentage`"},{"name":"workspace_id","expression":"`workspace_id`"},{"name":"clusterId","expression":"`clusterId`"},{"name":"notebookURL","expression":"`notebookURL`"}],"disaggregated":true}}],"spec":{"version":1,"widgetType":"table","encodings":{"columns":[{"fieldName":"sql_percentage","numberFormat":"%0.0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"float","displayAs":"number","visible":true,"order":0,"title":"sql %","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"description":"SQL commands vs. Total Commands","displayName":"sql_percentage"},{"fieldName":"workspace_id","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":2,"title":"workspace_id","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"workspace_id"},{"fieldName":"clusterId","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":4,"title":"clusterId","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"clusterId"},{"fieldName":"notebookURL","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"link","visible":true,"order":8,"title":"notebookURL","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"description":"Notebook Link","displayName":"notebookURL"}]},"invisibleColumns":[{"booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"notebookPath","type":"string","displayAs":"string","order":1,"title":"notebookPath","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false},{"booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"notebookId","type":"string","displayAs":"string","order":3,"title":"notebookId","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false},{"numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"total_command_execution","type":"integer","displayAs":"number","order":5,"title":"total_command_execution","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false},{"numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"sql_command_execution","type":"integer","displayAs":"number","order":6,"title":"sql_command_execution","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false},{"numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"non_sql_command_execution","type":"integer","displayAs":"number","order":7,"title":"non_sql_command_execution","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false}],"allowHTMLByDefault":false,"itemsPerPage":50,"paginationSize":"default","condensed":true,"withRowNumber":false,"frame":{"showTitle":true,"title":"SQL Notebooks that can be pointed at DBSQL Warehouses \nfor better experience, performance, tco"}}},"position":{"x":0,"y":11,"width":6,"height":8}},{"widget":{"name":"4d3ae174","queries":[{"name":"main_query","query":{"datasetName":"30567c7e","fields":[{"name":"cluster_name","expression":"`cluster_name`"},{"name":"sql_percentage","expression":"`sql_percentage`"},{"name":"workspace_id","expression":"`workspace_id`"},{"name":"cluster_source","expression":"`cluster_source`"},{"name":"commands","expression":"`commands`"}],"disaggregated":true}}],"spec":{"version":1,"widgetType":"table","encodings":{"columns":[{"fieldName":"cluster_name","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":0,"title":"cluster_name","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"cluster_name"},{"fieldName":"sql_percentage","numberFormat":"0.00","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"float","displayAs":"number","visible":true,"order":1,"title":"sql %","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"sql_percentage"},{"fieldName":"workspace_id","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":2,"title":"workspace_id","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"workspace_id"},{"fieldName":"cluster_source","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":3,"title":"cluster_source","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"cluster_source"},{"fieldName":"commands","numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"integer","displayAs":"number","visible":true,"order":4,"title":"commands","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"commands"}]},"invisibleColumns":[{"booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"clusterId","type":"string","displayAs":"string","order":5,"title":"clusterId","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false},{"numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"sql_commands","type":"integer","displayAs":"number","order":6,"title":"sql_commands","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false}],"allowHTMLByDefault":false,"itemsPerPage":50,"paginationSize":"default","condensed":true,"withRowNumber":false,"frame":{"showTitle":true,"title":"SQL mostly Interactive Clusters: Better, Faster, Cheaper to migrate to DBSQL (serverless)"}}},"position":{"x":0,"y":4,"width":6,"height":6}},{"widget":{"name":"4f386fe7","textbox_spec":"# Better SQL for Customers\nThis Dashboard will help identify high usage for Interactive clusters still being used for SQL workloads, that would be better served via the specialized DBSQL Warehouse endpoints.\n\n- Deploy this Lakeview dashboard to customer's account.\n\n- Ensure system tables are enabled and accessible, system.access.audit and system.compute.*\n"},"position":{"x":0,"y":0,"width":6,"height":4}},{"widget":{"name":"3d782f30","queries":[{"name":"main_query","query":{"datasetName":"20d751a8","fields":[{"name":"usage_quantity","expression":"`usage_quantity`"},{"name":"user_agent","expression":"`user_agent`"},{"name":"clusterId","expression":"`clusterId`"}],"disaggregated":true}}],"spec":{"version":1,"widgetType":"table","encodings":{"columns":[{"fieldName":"usage_quantity","numberFormat":"0,000.0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"decimal","displayAs":"number","visible":true,"order":100000,"title":"DBUs","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"usage_quantity"},{"fieldName":"user_agent","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":100002,"title":"user_agent","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"user_agent"},{"fieldName":"clusterId","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":100003,"title":"clusterId","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"clusterId"}]},"invisibleColumns":[{"numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"count","type":"integer","displayAs":"number","order":100001,"title":"count","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false}],"allowHTMLByDefault":false,"itemsPerPage":25,"paginationSize":"default","condensed":true,"withRowNumber":false,"frame":{"showTitle":true,"title":"BI Tools attached to Interactive Clusters"}}},"position":{"x":0,"y":20,"width":6,"height":6}},{"widget":{"name":"58eb0bc7","textbox_spec":""},"position":{"x":0,"y":10,"width":6,"height":1}},{"widget":{"name":"9a6cebe3","textbox_spec":""},"position":{"x":0,"y":19,"width":6,"height":1}}]}]}